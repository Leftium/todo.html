// Generated by CoffeeScript 1.6.3
(function() {
  define('store', ['jquery', 'twfile'], function($, file) {
    var load, normalizedPath, reStore, save;
    $(function() {
      var $body, bodyChildren;
      $body = $('body');
      bodyChildren = $('body > *');
      $(bodyChildren).detach();
      window.todotxt = $body.html();
      $body.empty();
      return bodyChildren.appendTo($body);
    });
    normalizedPath = function(filepath) {
      var path;
      if (!filepath) {
        return filepath = file.convertUriToLocalPath(location.href);
      } else {
        filepath = filepath.match(/^[ \t]*(.*?)[ \t\\\/]*$/)[1];
        if (filepath.search(/^([a-z]:)?[\/\\]/i === -1)) {
          path = file.convertUriToLocalPath(location.href);
          path = path.match(/^(.*[\\\/]).*?$/)[1];
          filepath = path + filepath;
        }
        return filepath = filepath.replace(/\//g, '\\');
      }
    };
    reStore = new RegExp('([\\s\\S]*### START STORE \\(for more info: www.todo.html\\) ###)' + '([\\s\\S]*)' + '(<!DOCTYPE html>[\\s\\S]*$)', 'm');
    load = function() {
      return JSON.parse(file.load(normalizedPath()).replace(reStore, '$2'));
    };
    save = function(store) {
      var jsonStr, newContents, oldContents;
      jsonStr = JSON.stringify(store);
      oldContents = file.load(normalizedPath());
      newContents = oldContents.replace(reStore, '$1\n' + jsonStr + '\n$3');
      return file.save(normalizedPath(), newContents);
    };
    return {
      normalizedPath: normalizedPath,
      load: load,
      save: save
    };
  });

}).call(this);
